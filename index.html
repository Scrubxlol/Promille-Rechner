<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Promille Rechner (Live)</title>
  <meta name="theme-color" content="#0a84ff">
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--text:#111;--muted:#666;--primary:#0a84ff;--danger:#b00020;--radius:14px}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);
         padding:env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom))}
    .wrap{max-width:820px;margin:0 auto}
    h1{font-size:1.4rem;margin:8px 4px 10px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-bottom:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    label{display:inline-flex;align-items:center;gap:6px;margin:6px 8px 6px 0}
    input,select,button{font-size:1rem;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.1);background:#fff}
    button{background:var(--primary);color:#fff;border:none;min-height:44px}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,.12)}
    .prom{font-size:1.8rem;font-weight:700;margin:10px 4px 6px}
    .muted{color:var(--muted)}
    .entry{margin-bottom:6px}
    #warn{display:none;background:rgba(255,0,0,.85);color:#fff;padding:12px;border-radius:12px;margin-bottom:12px;text-align:center;font-weight:700}
    body.danger{background:var(--danger)!important;color:#fff}
    canvas{width:100%;height:220px;display:block}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Promille Rechner</h1>

  <div id="warn">Ich trinke, um den Moment zu leben, nicht zu verlieren</div>

  <!-- Einstellungen -->
  <div class="card">
    <div class="row">
      <label>Gewicht:
        <input type="number" id="gewicht" min="40" max="200" step="1" value="70" style="width:110px"> kg
      </label>
      <span class="muted">Standard 70 kg (wird gespeichert)</span>
    </div>
  </div>

  <!-- Eingabe -->
  <div class="card">
    <div class="row">
      <label>GetrÃ¤nk:
        <select id="typ">
          <option value="bier">Bier (5%)</option>
          <option value="radler">Radler (2.5%)</option>
        </select>
      </label>
      <label>Menge:
        <select id="menge">
          <option value="0.3">0,3 L</option>
          <option value="0.4">0,4 L</option>
          <option value="0.5" selected>0,5 L</option>
        </select>
      </label>
    </div>
    <div class="row">
      <button id="add">Jetzt getrunken (Smart-Dauer)</button>
      <button id="reset" class="ghost">Alles lÃ¶schen</button>
    </div>
    <div class="muted" style="margin-top:8px">
      Standard-Trinkdauer: 0,3 L â‰ˆ 25 min Â· 0,4 L â‰ˆ 35 min Â· 0,5 L â‰ˆ 45 min
    </div>
  </div>

  <div class="prom" id="anzeige">Aktuelle Promille: 0,00â€°</div>

  <!-- Liste -->
  <div id="log" class="card">
    <b>GetrÃ¤nke</b>
    <div class="muted" id="empty">Noch nichts erfasst.</div>
  </div>

  <!-- Graph -->
  <div class="card">
    <b>Verlauf (nÃ¤chste 6 Stunden)</b>
    <canvas id="chart" width="800" height="220"></canvas>
    <div class="muted">Aktualisiert automatisch alle 5 min</div>
  </div>
</div>

<script>
/* ---------- Parameter ---------- */
const ABBAU = 0.13; // â€° pro Stunde
const R = 0.68;     // Verteilungsfaktor
const NF = new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});

// Standard-Trinkdauer in Minuten je Menge (feel free to tweak)
const DEFAULT_DAUER_MIN = { "0.3": 25, "0.4": 35, "0.5": 45 };

/* ---------- State ---------- */
let drinks = []; // { ty, s(L), g(Gramm Alc), tStart(ms), tEnd(ms) }

/* ---------- Storage ---------- */
const store = {
  get gewicht(){ return +(localStorage.getItem('pr_weight')||70); },
  set gewicht(v){ localStorage.setItem('pr_weight', String(v)); },
  load(){
    try{ drinks = JSON.parse(localStorage.getItem('pr_drinks')||'[]'); }
    catch{ drinks = []; }
  },
  save(){ localStorage.setItem('pr_drinks', JSON.stringify(drinks)); }
};

/* ---------- Helpers ---------- */
function alkoholGramm(typ, liter){
  const vol = (typ==='bier') ? 0.05 : 0.025;
  return liter * vol * 0.8 * 1000; // g
}

// Aufnahmemodell: gleichmÃ¤ÃŸige Aufnahme pro Minute wÃ¤hrend tStart..tEnd, danach linearer Abbau
function bacContributionAt(t, drink, gewicht){
  const mins = Math.max(1, Math.round((drink.tEnd - drink.tStart)/60000));
  const perMinGramm = drink.g / mins;
  let bac = 0;
  for(let ts = drink.tStart; ts <= drink.tEnd; ts += 60000){
    if (t < ts) continue; // noch nicht getrunken
    const z0 = perMinGramm / (gewicht * R); // Promille-Anstieg dieser Minute
    const hours = (t - ts) / 3600000;
    bac += Math.max(0, z0 - ABBAU * hours);
  }
  return bac;
}

function promilleAt(t){
  const gw = +document.getElementById('gewicht').value || 70;
  let sum = 0;
  for(const d of drinks){ sum += bacContributionAt(t, d, gw); }
  return sum;
}

function promilleJetzt(){ return promilleAt(Date.now()); }

/* ---------- UI ---------- */
function updateUI(){
  const p = promilleJetzt();
  document.getElementById('anzeige').textContent = 'Aktuelle Promille: ' + NF.format(p) + 'â€°';
  if(p >= 0.8){ document.body.classList.add('danger'); document.getElementById('warn').style.display='block'; }
  else { document.body.classList.remove('danger'); document.getElementById('warn').style.display='none'; }

  // Liste
  const log = document.getElementById('log');
  const empty = document.getElementById('empty');
  log.querySelectorAll('.entry').forEach(e=>e.remove());
  if(!drinks.length){ empty.style.display='block'; }
  else{
    empty.style.display='none';
    for(const d of drinks){
      const st = new Date(d.tStart).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
      const du = Math.round((d.tEnd - d.tStart)/60000);
      const div = document.createElement('div'); div.className='entry';
      div.textContent = `ðŸ•’ ${st} Â· ${NF.format(d.s)} L ${d.ty==='bier'?'Bier':'Radler'} Â· ${du} min`;
      log.appendChild(div);
    }
  }

  drawChart();
}

/* ---------- Graph ---------- */
function drawChart(){
  const cvs = document.getElementById('chart');
  const ctx = cvs.getContext('2d');
  const W = cvs.width, H = cvs.height;
  ctx.clearRect(0,0,W,H);
  // Achsen
  ctx.strokeStyle = '#ccc'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(40,H-30); ctx.lineTo(W-10,H-30); ctx.lineTo(W-10,20); ctx.stroke();

  const now = Date.now();
  const tMin = now, tMax = now + 6*3600000;
  const xOf = t => 40 + (W-60) * ((t - tMin)/(tMax - tMin));

  const points = [];
  for(let t = tMin; t <= tMax; t += 600000){ // alle 10 min
    points.push({t, p: promilleAt(t)});
  }

  const maxP = Math.max(0.8, ...points.map(p=>p.p)) * 1.2;
  const yOf = p => (H-30) - (H-60) * (p / (maxP||1));

  // 0.8â€° Linie
  ctx.strokeStyle = '#ff4d4d'; ctx.setLineDash([4,4]);
  const yWarn = yOf(0.8);
  ctx.beginPath(); ctx.moveTo(40,yWarn); ctx.lineTo(W-10,yWarn); ctx.stroke();
  ctx.setLineDash([]);

  // Kurve
  ctx.strokeStyle = '#0a84ff'; ctx.lineWidth = 2; ctx.beginPath();
  points.forEach((pt,i)=>{ const x=xOf(pt.t), y=yOf(pt.p); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // X-Labels stÃ¼ndlich
  ctx.fillStyle = '#666'; ctx.font = '12px -apple-system,system-ui';
  for(let t = tMin; t <= tMax; t += 3600000){
    const x = xOf(t);
    const lab = new Date(t).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    ctx.fillText(lab, x-14, H-10);
    ctx.beginPath(); ctx.strokeStyle = '#eee'; ctx.moveTo(x,H-30); ctx.lineTo(x,20); ctx.stroke();
  }
}

/* ---------- Events ---------- */
function addDrink(){
  const typ = document.getElementById('typ').value;
  const s = parseFloat(document.getElementById('menge').value);

  const grams = alkoholGramm(typ, s);
  const now = Date.now();
  const durMin = DEFAULT_DAUER_MIN[String(s)] || 45; // Fallback 45 min
  const start = now;                   // Smart: beginnt jetzt
  const end   = now + durMin*60000;    // endet nach Standarddauer

  drinks.push({ ty: typ, s, g: grams, tStart: start, tEnd: end });
  store.save();
  updateUI();
}

function resetAll(){
  if(confirm('Alles lÃ¶schen?')){
    drinks = []; store.save(); updateUI();
  }
}

function bind(){
  const gEl = document.getElementById('gewicht');
  gEl.value = store.gewicht;
  gEl.addEventListener('change', ()=>{ store.gewicht = Math.max(40,Math.min(200,+gEl.value||70)); updateUI(); });

  document.getElementById('add').onclick = addDrink;
  document.getElementById('reset').onclick = resetAll;

  // Auto-Update alle 5 min
  setInterval(updateUI, 5*60*1000);
}

/* ---------- Start ---------- */
store.load(); bind(); updateUI();
</script>
</body>
</html>
