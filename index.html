<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Promille Rechner (Live)</title>
  <meta name="theme-color" content="#0a84ff">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root{
      --bg:#0b0b0b;--card:#151515;--text:#f2f2f2;--muted:#aaa;
      --primary:#0a84ff;--danger:#b00020;--radius:14px;
      --grid:#444;--axis:#888;--curve:#4dd0e1;--warn:#ff5252
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7f7;--card:#ffffff;--text:#111;--muted:#666;
        --grid:#eee;--axis:#666;--curve:#0a84ff;--warn:#ff3333
      }
    }
    html,body{height:100%}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:var(--text);
      padding:env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom))
    }
    .wrap{max-width:860px;margin:0 auto}
    h1{font-size:1.4rem;margin:8px 4px 10px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-bottom:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    label{display:inline-flex;align-items:center;gap:6px;margin:6px 8px 6px 0}
    input,select,button{font-size:1rem;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#111;color:var(--text)}
    @media (prefers-color-scheme: light){input,select,button{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,.18)}}
    button{background:var(--primary);color:#fff;border:none;min-height:44px}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
    .prom{font-size:1.8rem;font-weight:700;margin:10px 4px 6px}
    .muted{color:var(--muted)}
    .entry{margin-bottom:6px}
    #warn{display:none;background:rgba(255,0,0,.9);color:#fff;padding:12px;border-radius:12px;margin-bottom:12px;text-align:center;font-weight:700}
    body.danger{background:var(--danger)!important;color:#fff}
    canvas{width:100%;height:240px;display:block;border-radius:12px;background:var(--card)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Promille Rechner</h1>

  <div id="warn">Ich trinke, um den Moment zu leben, nicht zu verlieren</div>

  <!-- Einstellungen -->
  <div class="card">
    <div class="row">
      <label>Gewicht:
        <input aria-label="Gewicht in kg" type="number" id="gewicht" min="40" max="200" step="1" value="70" style="width:110px"> kg
      </label>
      <span class="muted">Standard 70 kg (wird gespeichert)</span>
    </div>
  </div>

  <!-- Eingabe -->
  <div class="card">
    <div class="row">
      <label>GetrÃ¤nk:
        <select aria-label="GetrÃ¤nktyp" id="typ">
          <option value="bier">Bier (5 %)</option>
          <option value="radler">Radler (2,5 %)</option>
          <option value="shot">Shot (40 %)</option>
        </select>
      </label>
      <label>Menge:
        <select aria-label="Menge" id="menge"></select>
      </label>
    </div>
    <div class="actions">
      <button id="add">Jetzt getrunken</button>
      <button id="update" class="ghost" aria-label="Manuell aktualisieren">ðŸ”„ Aktualisieren</button>
      <button id="reset" class="ghost" aria-label="Alle EintrÃ¤ge lÃ¶schen">Alles lÃ¶schen</button>
    </div>
    <div class="muted" id="dauerHinweis" style="margin-top:8px"></div>
  </div>

  <div class="prom" id="anzeige">Aktuelle Promille: 0,000â€°</div>

  <!-- Liste -->
  <div id="log" class="card" aria-live="polite">
    <b>GetrÃ¤nke</b>
    <div class="muted" id="empty">Noch nichts erfasst.</div>
  </div>

  <!-- Graph -->
  <div class="card">
    <b>Verlauf (nÃ¤chste 6 Stunden)</b>
    <canvas id="chart"></canvas>
    <div class="muted">Aktualisiert automatisch alle 2 Minuten</div>
  </div>
</div>

<script>
/* ---------- Parameter ---------- */
const ABBAU = 0.13;                 // â€° pro Stunde (Eliminationsrate)
const R = 0.68;                     // Verteilungsfaktor
const NF = new Intl.NumberFormat('de-DE',{minimumFractionDigits:3,maximumFractionDigits:3});
const DEFAULT_DAUER_MIN = {         // Standard-Trinkdauer in Minuten
  bier:  { "0.3":25, "0.4":35, "0.5":45 },
  radler:{ "0.3":20, "0.4":28, "0.5":36 },
  shot:  { "0.02":5,  "0.04":8  }
};

/* ---------- State + Storage ---------- */
let drinks = []; // { ty, s(L), g(Gramm Alc), tStart(ms), tEnd(ms) }

const store = {
  get gewicht(){ return +(localStorage.getItem('pr_weight')||70); },
  set gewicht(v){ localStorage.setItem('pr_weight', String(v)); },
  load(){
    try{ drinks = JSON.parse(localStorage.getItem('pr_drinks')||'[]'); }
    catch{ drinks = []; }
  },
  save(){ localStorage.setItem('pr_drinks', JSON.stringify(drinks)); }
};

/* ---------- Helpers ---------- */
function alkoholGramm(typ, liter){
  let vol = 0.05;
  if(typ==='radler') vol = 0.025;
  if(typ==='shot')   vol = 0.40;
  return liter * vol * 0.8 * 1000; // Gramm reiner Alkohol
}

// Hybrid-Aufnahme: groÃŸer Sofort-Anteil + kurzer Nachlauf
function bacContributionAt(t, drink, gewicht){
  const fImmediate = (drink.ty === 'shot') ? 0.70 : 0.60; // Sofortanteil
  const slowMinutes = (drink.ty === 'shot') ? 10 : 30;    // Nachlaufdauer

  const g0 = drink.g * fImmediate;        // sofort
  const gS = drink.g - g0;                 // langsam
  const start = drink.tStart;

  let bac = 0;

  // Sofort-Anteil: als "eine Minute" zum Startzeitpunkt
  if (t >= start) {
    const z0 = g0 / (gewicht * R);
    const hours = (t - start) / 3600000;
    bac += Math.max(0, z0 - ABBAU * hours);
  }

  // Langsam-Anteil: gleichmÃ¤ÃŸig pro Minute Ã¼ber slowMinutes
  const perMin = (slowMinutes > 0) ? (gS / slowMinutes) : 0;
  const endSlow = start + slowMinutes * 60000;

  for (let ts = start; ts < endSlow; ts += 60000) {
    if (t < ts) continue;                  // noch nicht im Blut
    const z = perMin / (gewicht * R);      // Promille-Anstieg aus dieser Minute
    const hours = (t - ts) / 3600000;
    bac += Math.max(0, z - ABBAU * hours); // Abbau seit Aufnahme
  }
  return bac;
}

function promilleAt(t){
  const gw = +document.getElementById('gewicht').value || 70;
  let sum = 0;
  for(const d of drinks){ sum += bacContributionAt(t, d, gw); }
  return sum;
}

function promilleJetzt(){ return promilleAt(Date.now()); }

/* ---------- UI ---------- */
const typSel = document.getElementById('typ');
const mengeSel = document.getElementById('menge');
const dauerHinweis = document.getElementById('dauerHinweis');

function fillMengen(){
  const t = typSel.value;
  const opts = (t==='shot')
    ? [{v:'0.02',l:'2 cl'},{v:'0.04',l:'4 cl'}]
    : [{v:'0.3',l:'0,3 L'},{v:'0.4',l:'0,4 L'},{v:'0.5',l:'0,5 L'}];
  mengeSel.innerHTML = '';
  opts.forEach(o=>{
    const el=document.createElement('option');
    el.value=o.v; el.textContent=o.l; mengeSel.appendChild(el);
  });
  // Default-Auswahl
  if(t==='shot') mengeSel.value='0.02'; else mengeSel.value='0.5';
  setDauerHint();
}
function setDauerHint(){
  const t=typSel.value, s=mengeSel.value;
  const d = DEFAULT_DAUER_MIN[t][s] || 45;
  if(t==='shot') dauerHinweis.textContent = (s==='0.02'?'~5 min':'~8 min');
  else dauerHinweis.textContent = '0,3 L â‰ˆ 25 min Â· 0,4 L â‰ˆ 35 min Â· 0,5 L â‰ˆ 45 min';
}

function updateList(){
  const log = document.getElementById('log');
  const empty = document.getElementById('empty');
  log.querySelectorAll('.entry').forEach(e=>e.remove());
  if(!drinks.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  drinks.forEach((d,i)=>{
    const st = new Date(d.tStart).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    const du = Math.round((d.tEnd - d.tStart)/60000);
    const div = document.createElement('div'); div.className='entry';
    const name = d.ty==='shot' ? (d.s===0.04?'Shot 4 cl':'Shot 2 cl') : `${(d.s).toFixed(1).replace('.',',')} L ${d.ty==='bier'?'Bier':'Radler'}`;
    div.innerHTML = `ðŸ•’ ${st} Â· ${name} Â· ${du} min <button class="ghost" data-del="${i}" aria-label="Eintrag lÃ¶schen">Ã—</button>`;
    log.appendChild(div);
  });
  log.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = () => { drinks.splice(+btn.dataset.del,1); store.save(); updateUI(); };
  });
}

function updateUI(){
  const p = promilleJetzt();
  document.getElementById('anzeige').textContent = 'Aktuelle Promille: ' + NF.format(p) + 'â€°';
  if(p >= 0.8){ document.body.classList.add('danger'); document.getElementById('warn').style.display='block'; }
  else { document.body.classList.remove('danger'); document.getElementById('warn').style.display='none'; }
  updateList();
  drawChart();
}

/* ---------- Graph ---------- */
function drawChart(){
  const cvs = document.getElementById('chart');
  const ctx = cvs.getContext('2d');

  // Retina-SchÃ¤rfe
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const cssW = cvs.clientWidth || 800;
  const cssH = 240;
  cvs.width  = Math.round(cssW * dpr);
  cvs.height = Math.round(cssH * dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);

  const W = cssW, H = cssH, PADL=44, PADB=28, PADT=16, PADR=10;
  ctx.clearRect(0,0,W,H);

  const now = Date.now();
  const tMin = now, tMax = now + 6*3600000;
  const xOf = t => PADL + (W-PADL-PADR) * ((t - tMin)/(tMax - tMin));

  // Samples alle 5 Minuten fÃ¼r weiche Kurve
  const points = [];
  for(let t=tMin; t<=tMax; t+=5*60000){ points.push({t, p: promilleAt(t)}); }

  const maxP = Math.max(0.8, ...points.map(p=>p.p)) * 1.2 || 1;
  const yOf = p => (H-PADB) - (H-PADT-PADB) * (p / maxP);

  // Grid + Achsen
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim() || '#444';
  ctx.lineWidth = 1;
  for(let p=0; p<=maxP; p+=0.2){
    const y=yOf(p); ctx.beginPath(); ctx.moveTo(PADL,y); ctx.lineTo(W-PADR,y); ctx.stroke();
  }
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--axis').trim() || '#888';
  ctx.beginPath(); ctx.moveTo(PADL,H-PADB); ctx.lineTo(W-PADR,H-PADB); ctx.lineTo(W-PADR,PADT); ctx.stroke();

  // 0.8â€° Linie
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim() || '#ff5252';
  ctx.setLineDash([4,4]);
  const yWarn = yOf(0.8);
  ctx.beginPath(); ctx.moveTo(PADL,yWarn); ctx.lineTo(W-PADR,yWarn); ctx.stroke();
  ctx.setLineDash([]);

  // Kurve
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--curve').trim() || '#4dd0e1';
  ctx.lineWidth = 2; ctx.beginPath();
  points.forEach((pt,i)=>{ const x=xOf(pt.t), y=yOf(pt.p); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // X-Labels stÃ¼ndlich
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#aaa';
  ctx.font = '12px -apple-system,system-ui';
  for(let t=tMin; t<=tMax; t+=3600000){
    const x = xOf(t);
    const lab = new Date(t).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    ctx.fillText(lab, x-14, H-8);
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim() || '#444';
    ctx.beginPath(); ctx.moveTo(x,H-PADB); ctx.lineTo(x,PADT); ctx.stroke();
  }

  // Y-Labels
  ctx.textAlign='right'; ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#aaa';
  for(let p=0; p<=maxP; p+=0.2){ const y=yOf(p); ctx.fillText(p.toFixed(1).replace('.',','), PADL-6, y+4); }
}

/* ---------- Events ---------- */
function addDrink(){
  const typ = typSel.value;
  const s = parseFloat(mengeSel.value);
  const grams = alkoholGramm(typ, s);
  const now = Date.now();
  const durMin = (DEFAULT_DAUER_MIN[typ] && DEFAULT_DAUER_MIN[typ][String(s)]) || 45;
  const start = now;
  const end   = now + durMin*60000;
  drinks.push({ ty: typ, s, g: grams, tStart: start, tEnd: end });
  store.save();
  updateUI();
}

function resetAll(){
  if(confirm('Alles lÃ¶schen?')){
    drinks = []; store.save(); updateUI();
  }
}

function bind(){
  // Menge je Typ
  typSel.onchange = ()=>{ fillMengen(); updateUI(); };
  mengeSel.onchange = ()=> setDauerHint();
  fillMengen();

  // Gewicht
  const gEl = document.getElementById('gewicht');
  gEl.value = store.gewicht;
  gEl.addEventListener('change', ()=>{ store.gewicht = Math.max(40,Math.min(200,+gEl.value||70)); updateUI(); });

  // Buttons
  document.getElementById('add').onclick = addDrink;
  document.getElementById('reset').onclick = resetAll;
  document.getElementById('update').onclick = updateUI;

  // Auto-Update alle 2 Minuten
  setInterval(updateUI, 2*60*1000);
}

/* ---------- Start ---------- */
store.load(); bind(); updateUI();

// PWA: Service Worker registrieren (optional; fÃ¼r GitHub Pages ok)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>
