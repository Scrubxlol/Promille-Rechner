<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Promille Rechner (Live + Plan)</title>
  <meta name="theme-color" content="#0a84ff">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root{
      --bg:#0b0b0b;--card:#151515;--text:#f2f2f2;--muted:#aaa;
      --primary:#0a84ff;--danger:#b00020;--radius:14px;
      --grid:#444;--axis:#888;--curve:#4dd0e1;--warn:#ff5252;--tableRow:#1e1e1e
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7f7;--card:#ffffff;--text:#111;--muted:#666;
        --grid:#eee;--axis:#666;--curve:#0a84ff;--warn:#ff3333;--tableRow:#f2f2f2
      }
    }
    html,body{height:100%}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:var(--text);
      padding:env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom))
    }
    .wrap{max-width:900px;margin:0 auto}
    h1{font-size:1.4rem;margin:8px 4px 10px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-bottom:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    label{display:inline-flex;align-items:center;gap:6px;margin:6px 8px 6px 0}
    input,select,button{font-size:1rem;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#111;color:var(--text)}
    @media (prefers-color-scheme: light){input,select,button{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,.18)}}
    button{background:var(--primary);color:#fff;border:none;min-height:44px}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
    .prom{font-size:1.8rem;font-weight:700;margin:10px 4px 6px}
    .muted{color:var(--muted)}
    .entry{margin-bottom:6px}
    #warn{display:none;background:rgba(255,0,0,.9);color:#fff;padding:12px;border-radius:12px;margin-bottom:12px;text-align:center;font-weight:700}
    body.danger{background:var(--danger)!important;color:#fff}
    canvas{width:100%;height:240px;display:block;border-radius:12px;background:var(--card)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    tr:nth-child(odd){background:var(--tableRow)}
    th{text-align:left}
    .plan-entry{display:flex;align-items:center;gap:8px;margin-top:8px}
    .plan-list .entry{display:flex;justify-content:space-between;align-items:center}

    /* --- Pop-out Plan Drawer --- */
    .fab{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:var(--primary); color:#fff; font-size:24px; border:none;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    #planPanel{
      position:fixed; right:16px; bottom:88px; z-index:9998;
      width:min(92vw, 360px);
      transform:translateY(12px); opacity:0; pointer-events:none;
      transition:transform .18s ease, opacity .18s ease;
    }
    #planPanel.open{ transform:translateY(0); opacity:1; pointer-events:auto; }
    #planPanel .card{ margin-bottom:0; overflow:auto; max-height:min(70vh, 520px); }
    #planHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    #planHeader b{ font-size:1rem; }
    #planClose{ background:transparent; border:1px solid rgba(255,255,255,.2); color:var(--text); padding:6px 10px; border-radius:10px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Promille Rechner</h1>

  <div id="warn">Ich trinke, um den Moment zu leben, nicht zu verlieren</div>

  <!-- Einstellungen -->
  <div class="card">
    <div class="row">
      <label>Gewicht:
        <input aria-label="Gewicht in kg" type="number" id="gewicht" min="40" max="200" step="1" value="70" style="width:110px"> kg
      </label>
      <label>Geschlecht:
        <select id="sex">
          <option value="m">mÃ¤nnlich</option>
          <option value="w">weiblich</option>
        </select>
      </label>
      <span class="muted">70 kg Standard Â· r: m 0,68 / w 0,55</span>
    </div>
  </div>

  <!-- Eingabe (jetzt trinken) -->
  <div class="card">
    <div class="row">
      <label>GetrÃ¤nk:
        <select aria-label="GetrÃ¤nktyp" id="typ">
          <option value="bier">Bier (5 %)</option>
          <option value="radler">Radler (2,5 %)</option>
          <option value="shot">Shot (40 %)</option>
        </select>
      </label>
      <label>Menge:
        <select aria-label="Menge" id="menge"></select>
      </label>
    </div>
    <div class="actions">
      <button id="add">Jetzt getrunken</button>
      <button id="update" class="ghost" aria-label="Manuell aktualisieren">ðŸ”„ Aktualisieren</button>
      <button id="reset" class="ghost" aria-label="Alle EintrÃ¤ge lÃ¶schen">Alles lÃ¶schen</button>
    </div>
    <div class="muted" id="dauerHinweis" style="margin-top:8px"></div>
  </div>

  <div class="prom" id="anzeige">Aktuelle Promille: 0,000â€°</div>

  <!-- Liste -->
  <div id="log" class="card" aria-live="polite">
    <b>GetrÃ¤nke</b>
    <div class="muted" id="empty">Noch nichts erfasst.</div>
  </div>

  <!-- Graph -->
  <div class="card">
    <b>Verlauf (nÃ¤chste 6 Stunden)</b>
    <canvas id="chart"></canvas>
    <div class="muted">Aktualisiert automatisch alle 2 Minuten</div>
  </div>
</div>

<!-- FAB (nur fÃ¼r dich) -->
<button class="fab" id="planToggle" aria-label="Trinkplan Ã¶ffnen/schlieÃŸen">ðŸ§ª</button>

<!-- Pop-out Panel mit deinem bisherigen Plan-Bereich -->
<div id="planPanel" aria-hidden="true">
  <div class="card">
    <div id="planHeader">
      <b>Trinkplan (Simulation)</b>
      <button id="planClose" class="ghost">SchlieÃŸen</button>
    </div>

    <div class="plan-entry">
      <label>GetrÃ¤nk:
        <select id="planTyp">
          <option value="bier">Bier (5 %)</option>
          <option value="radler">Radler (2,5 %)</option>
          <option value="shot">Shot (40 %)</option>
        </select>
      </label>
      <label>Menge:
        <select id="planMenge"></select>
      </label>
      <label>Start in:
        <input type="number" id="planStartMin" value="30" step="5" min="0" style="width:90px"> min
      </label>
      <label>Dauer:
        <input type="number" id="planDauerMin" value="30" step="5" min="1" style="width:90px"> min
      </label>
      <button id="planAdd">Zum Plan</button>
    </div>

    <div class="actions" style="margin-top:8px">
      <label><input type="checkbox" id="planInclude" checked> Plan in Grafik & Tabelle berÃ¼cksichtigen</label>
      <button id="planClear" class="ghost">Plan leeren</button>
    </div>

    <div class="plan-list" id="planList" style="margin-top:8px">
      <div class="muted" id="planEmpty">Kein geplanter Drink.</div>
    </div>

    <h4 style="margin-top:12px">Simulation (alle 10 Minuten, 3 Stunden)</h4>
    <table id="simTable">
      <thead><tr><th>Zeit</th><th>Promille (â€°)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ---------- Parameter ---------- */
const ABBAU = 0.12;                 // â€° pro Stunde (Null-Ordnung)
const NF = new Intl.NumberFormat('de-DE',{minimumFractionDigits:3,maximumFractionDigits:3});
const DEFAULT_DAUER_MIN = {
  bier:  { "0.3":25, "0.4":35, "0.5":45 },
  radler:{ "0.3":20, "0.4":28, "0.5":36 },
  shot:  { "0.02":5,  "0.04":8  }
};
const F_IMMEDIATE = 0.70;           // 70% sofort, 30% langsam

/* ---------- State + Storage ---------- */
let drinks = []; // { ty, s(L), g, tStart(ms), tEnd(ms) }
let plans  = [];

const store = {
  get gewicht(){ return +(localStorage.getItem('pr_weight')||70); },
  set gewicht(v){ localStorage.setItem('pr_weight', String(v)); },
  load(){
    try{ drinks = JSON.parse(localStorage.getItem('pr_drinks')||'[]'); }
    catch{ drinks = []; }
  },
  save(){ localStorage.setItem('pr_drinks', JSON.stringify(drinks)); }
};

/* ---------- Personalisierung ---------- */
function getR(){
  const s = document.getElementById('sex')?.value || 'm';
  return s === 'w' ? 0.55 : 0.68;
}

/* ---------- Alkohol & Aufnahme ---------- */
function alkoholGramm(typ, liter){
  // 0.789 g/ml (genauer)
  let vol = 0.05; if(typ==='radler') vol=0.025; if(typ==='shot') vol=0.40;
  return liter * vol * 0.789 * 1000; // Gramm reiner Alkohol
}

// Halbwertszeiten (Exponentielle Aufnahme des langsamen Anteils)
function tauFor(drink){
  return drink.ty === 'shot' ? 6 : 12; // Minuten
}

// Intake-Zeitreihe (Gramm/Minute) fÃ¼r EIN GetrÃ¤nk: 70% sofort, 30% mit exp. Halbwertszeit Ã¼ber reale Dauer
function intakeSeriesForDrink(drink){
  const startMin = Math.floor(drink.tStart / 60000);
  const endMin   = Math.max(startMin+1, Math.ceil(drink.tEnd / 60000));
  const slowLen  = endMin - startMin;

  const g0 = drink.g * F_IMMEDIATE;     // sofort am Start
  const gS = drink.g - g0;               // langsamer Anteil
  const tau = tauFor(drink);
  const k = Math.log(2) / (tau || 1);

  const absorbedAt = (m) => gS * (1 - Math.exp(-k * Math.min(m, slowLen)));

  const series = new Map();
  // Sofortanteil zum Start
  series.set(startMin, (series.get(startMin)||0) + g0);
  // pro Minute: Zuwachs des langsamen Anteils
  for(let i=0; i<slowLen; i++){
    const inc = absorbedAt(i+1) - absorbedAt(i);
    const tMin = startMin + i;
    series.set(tMin, (series.get(tMin)||0) + inc);
  }
  return {series, startMin, endMin};
}

// Alle GetrÃ¤nke zusammenfÃ¼hren
function buildSchedule(allDrinks){
  const sched = new Map();
  let minMin = Math.floor(Date.now()/60000), maxMin = minMin;
  for(const d of allDrinks){
    const {series, startMin, endMin} = intakeSeriesForDrink(d);
    minMin = Math.min(minMin, startMin);
    maxMin = Math.max(maxMin, endMin);
    for(const [m, g] of series.entries()){
      sched.set(m, (sched.get(m)||0) + g);
    }
  }
  return {sched, minMin, maxMin};
}

// Null-Ordnung integrieren: einmal pro Minute abziehen
function integrateSeries(allDrinks, endMs, gewicht, r){
  const {sched, minMin} = buildSchedule(allDrinks);
  const endMin = Math.floor(endMs/60000);
  let bac = 0;
  const series = new Map();
  for(let m = minMin; m <= endMin; m++){
    const grams = sched.get(m) || 0;
    bac = Math.max(0, bac + grams/(gewicht*r) - ABBAU/60);
    series.set(m, bac);
  }
  return {startMin: minMin, endMin, series};
}

function includePlan(){ return document.getElementById('planInclude')?.checked; }
function promilleJetztValue(){
  const arr = includePlan()? drinks.concat(plans) : drinks;
  const gw = +document.getElementById('gewicht').value || 70;
  const r  = getR();
  const {endMin, series} = integrateSeries(arr, Date.now(), gw, r);
  return series.get(endMin) || 0;
}

/* ---------- UI: Jetzt-Drinks ---------- */
const typSel = document.getElementById('typ');
const mengeSel = document.getElementById('menge');
const dauerHinweis = document.getElementById('dauerHinweis');

function fillMengen(selTyp, selMengeEl){
  const t = selTyp.value, el = selMengeEl;
  const opts = (t==='shot')
    ? [{v:'0.02',l:'2 cl'},{v:'0.04',l:'4 cl'}]
    : [{v:'0.3',l:'0,3 L'},{v:'0.4',l:'0,4 L'},{v:'0.5',l:'0,5 L'}];
  el.innerHTML=''; opts.forEach(o=>{const op=document.createElement('option');op.value=o.v;op.textContent=o.l;el.appendChild(op);});
  if(t==='shot') el.value='0.02'; else el.value='0.5';
}
function setDauerHint(){
  const t=typSel.value, s=mengeSel.value;
  if(t==='shot') dauerHinweis.textContent = (s==='0.02'?'~5 min':'~8 min');
  else dauerHinweis.textContent = '0,3 L â‰ˆ 25 min Â· 0,4 L â‰ˆ 35 min Â· 0,5 L â‰ˆ 45 min';
}
function updateList(){
  const log = document.getElementById('log'), empty = document.getElementById('empty');
  log.querySelectorAll('.entry').forEach(e=>e.remove());
  if(!drinks.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  drinks.forEach((d,i)=>{
    const st = new Date(d.tStart).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    const du = Math.round((d.tEnd - d.tStart)/60000);
    const div = document.createElement('div'); div.className='entry';
    const name = d.ty==='shot' ? (d.s===0.04?'Shot 4 cl':'Shot 2 cl') : `${(d.s).toFixed(1).replace('.',',')} L ${d.ty==='bier'?'Bier':'Radler'}`;
    div.innerHTML = `ðŸ•’ ${st} Â· ${name} Â· ${du} min <button class="ghost" data-del="${i}" aria-label="Eintrag lÃ¶schen">Ã—</button>`;
    log.appendChild(div);
  });
  log.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = () => { drinks.splice(+btn.dataset.del,1); store.save(); updateUI(); };
  });
}

/* ---------- Graph ---------- */
function drawChart(){
  const cvs = document.getElementById('chart');
  const ctx = cvs.getContext('2d');

  // Retina
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const cssW = cvs.clientWidth || 800, cssH = 240;
  cvs.width = Math.round(cssW*dpr); cvs.height = Math.round(cssH*dpr);
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);

  const W=cssW,H=cssH, PADL=44,PADB=28,PADT=16,PADR=10;
  ctx.clearRect(0,0,W,H);

  const now=Date.now(), tMin=now, tMax=now+6*3600e3;
  const xOf = t => PADL + (W-PADL-PADR) * ((t - tMin)/(tMax - tMin));
  const css = (n,f) => getComputedStyle(document.documentElement).getPropertyValue(n).trim() || f;

  const arr = includePlan()? drinks.concat(plans) : drinks;
  const gw = +document.getElementById('gewicht').value || 70;
  const r  = getR();

  const {series} = integrateSeries(arr, tMax, gw, r);

  const points=[];
  for(let ms = tMin; ms <= tMax; ms += 2*60000){
    const m = Math.floor(ms/60000);
    points.push({t:ms, p: series.get(m) ?? 0});
  }

  const maxP=Math.max(0.8,...points.map(p=>p.p))*1.2 || 1;
  const yOf = p => (H-PADB) - (H-PADT-PADB)*(p/maxP);

  // Grid + Achsen
  ctx.strokeStyle = css('--grid','#444'); ctx.lineWidth=1;
  for(let p=0;p<=maxP;p+=0.2){ const y=yOf(p); ctx.beginPath(); ctx.moveTo(PADL,y); ctx.lineTo(W-PADR,y); ctx.stroke(); }
  ctx.strokeStyle = css('--axis','#888');
  ctx.beginPath(); ctx.moveTo(PADL,H-PADB); ctx.lineTo(W-PADR,H-PADB); ctx.lineTo(W-PADR,PADT); ctx.stroke();

  // 0.8â€° Linie
  ctx.strokeStyle = css('--warn','#ff5252'); ctx.setLineDash([4,4]);
  const yWarn=yOf(0.8); ctx.beginPath(); ctx.moveTo(PADL,yWarn); ctx.lineTo(W-PADR,yWarn); ctx.stroke(); ctx.setLineDash([]);

  // Kurve
  ctx.strokeStyle = css('--curve','#4dd0e1'); ctx.lineWidth=2; ctx.beginPath();
  points.forEach((pt,i)=>{ const x=xOf(pt.t),y=yOf(pt.p); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }); ctx.stroke();

  // X-Labels
  ctx.fillStyle = css('--muted','#aaa'); ctx.font='12px -apple-system,system-ui';
  for(let ms=tMin; ms<=tMax; ms+=3600000){
    const x=xOf(ms); const lab=new Date(ms).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    ctx.fillText(lab,x-14,H-8);
    ctx.beginPath(); ctx.strokeStyle=css('--grid','#444'); ctx.moveTo(x,H-PADB); ctx.lineTo(x,PADT); ctx.stroke();
  }

  // Y-Labels
  ctx.textAlign='right'; ctx.fillStyle=css('--muted','#aaa');
  for(let p=0;p<=maxP;p+=0.2){ const y=yOf(p); ctx.fillText(p.toFixed(1).replace('.',','),PADL-6,y+4); }
}

/* ---------- Simulationstabelle ---------- */
function updateSimTable(){
  const tbody = document.querySelector('#simTable tbody');
  tbody.innerHTML='';
  const arr = includePlan()? drinks.concat(plans) : drinks;
  const gw = +document.getElementById('gewicht').value || 70;
  const r  = getR();
  const start=Date.now(), end=start+3*3600e3;

  const {series} = integrateSeries(arr, end, gw, r);
  for(let ms=start; ms<=end; ms+=10*60000){
    const m=Math.floor(ms/60000);
    const tr=document.createElement('tr');
    const td1=document.createElement('td'), td2=document.createElement('td');
    td1.textContent=new Date(ms).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    td2.textContent=NF.format(series.get(m)||0)+'â€°';
    tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
  }
}

/* ---------- Plan-UI ---------- */
const planTyp=document.getElementById('planTyp');
const planMenge=document.getElementById('planMenge');
const planStartMin=document.getElementById('planStartMin');
const planDauerMin=document.getElementById('planDauerMin');

function fillPlanMengen(){
  fillMengen(planTyp, planMenge);
  const t=planTyp.value,s=planMenge.value;
  planDauerMin.value=(DEFAULT_DAUER_MIN[t]&&DEFAULT_DAUER_MIN[t][s])||30;
}
planTyp.onchange=()=>{ fillPlanMengen(); };
planMenge.onchange=()=>{ const t=planTyp.value,s=planMenge.value; planDauerMin.value=(DEFAULT_DAUER_MIN[t]&&DEFAULT_DAUER_MIN[t][s])||30; };

document.getElementById('planAdd').onclick=()=>{
  const ty=planTyp.value, s=parseFloat(planMenge.value);
  const start=Date.now()+Math.max(0,(+planStartMin.value||0))*60000;
  const dur=Math.max(1,(+planDauerMin.value||30));
  const grams=alkoholGramm(ty,s);
  plans.push({ ty, s, g:grams, tStart:start, tEnd:start+dur*60000 });
  renderPlanList(); updateUI();
};
document.getElementById('planClear').onclick=()=>{ plans=[]; renderPlanList(); updateUI(); };
document.getElementById('planInclude').onchange=()=>{ updateUI(); };

function renderPlanList(){
  const box=document.getElementById('planList'), empty=document.getElementById('planEmpty');
  box.querySelectorAll('.entry').forEach(e=>e.remove());
  if(!plans.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  plans.forEach((p,i)=>{
    const name=p.ty==='shot'?(p.s===0.04?'Shot 4 cl':'Shot 2 cl'):`${(p.s).toFixed(1).replace('.',',')} L ${p.ty==='bier'?'Bier':'Radler'}`;
    const st=new Date(p.tStart).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    const du=Math.round((p.tEnd-p.tStart)/60000);
    const row=document.createElement('div'); row.className='entry';
    row.innerHTML=`<span>ðŸ“… ${st} Â· ${name} Â· ${du} min</span><button class="ghost" data-del="${i}">Ã—</button>`;
    box.appendChild(row);
  });
  box.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick=()=>{ plans.splice(+btn.dataset.del,1); renderPlanList(); updateUI(); };
  });
}

/* ---------- Update-Kaskade ---------- */
function updateUI(){
  const p = promilleJetztValue();
  document.getElementById('anzeige').textContent = 'Aktuelle Promille: ' + NF.format(p) + 'â€°';
  if(p >= 0.8){ document.body.classList.add('danger'); document.getElementById('warn').style.display='block'; }
  else { document.body.classList.remove('danger'); document.getElementById('warn').style.display='none'; }
  updateList(); drawChart(); updateSimTable();
}

/* ---------- Events ---------- */
function addDrink(){
  const typ=typSel.value, s=parseFloat(mengeSel.value);
  const grams=alkoholGramm(typ,s);
  const now=Date.now();
  const dminMap=DEFAULT_DAUER_MIN[typ]||{};
  const durMin=dminMap[String(s)]||(typ==='shot'?6:45);
  drinks.push({ ty:typ, s, g:grams, tStart:now, tEnd:now+durMin*60000 });
  store.save(); updateUI();
}
function resetAll(){ if(confirm('Alles lÃ¶schen?')){ drinks=[]; store.save(); updateUI(); } }
function bind(){
  // Jetzt
  fillMengen(typSel,mengeSel); setDauerHint();
  typSel.onchange=()=>{ fillMengen(typSel,mengeSel); setDauerHint(); updateUI(); };
  mengeSel.onchange=()=> setDauerHint();

  // Plan
  fillPlanMengen();

  // Gewicht + Geschlecht
  const gEl=document.getElementById('gewicht'); gEl.value=store.gewicht;
  gEl.addEventListener('change',()=>{ store.gewicht=Math.max(40,Math.min(200,+gEl.value||70)); updateUI(); });
  document.getElementById('sex').addEventListener('change', updateUI);

  // Buttons
  document.getElementById('add').onclick=addDrink;
  document.getElementById('reset').onclick=resetAll;
  document.getElementById('update').onclick=updateUI;

  // Auto-Update alle 2 Minuten
  setInterval(updateUI, 2*60*1000);

  // Pop-out toggles
  const panel = document.getElementById('planPanel');
  const toggle= document.getElementById('planToggle');
  const close = document.getElementById('planClose');
  const setOpen = (open) => {
    panel.classList.toggle('open', open);
    panel.setAttribute('aria-hidden', open ? 'false' : 'true');
  };
  toggle.addEventListener('click', ()=> setOpen(!panel.classList.contains('open')));
  close.addEventListener('click',  ()=> setOpen(false));
}

/* ---------- Start ---------- */
store.load(); bind(); updateUI();

// PWA: optional
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>
